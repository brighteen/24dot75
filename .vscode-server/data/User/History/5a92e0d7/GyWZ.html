{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- 사이드바 -->
    <div id="sidebar" class="col-md-3 p-0 d-none d-md-block">
      <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">
            <i class="bi bi-chat-text mr-2"></i>대화 기록
          </h5>
          <button id="sidebar-close" class="btn btn-sm btn-light d-md-none">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        
        <a href="{% url 'board:chat' %}" class="btn btn-primary btn-block mb-3">
          <i class="bi bi-plus-circle mr-2"></i>새 채팅 시작
        </a>
        
        <div class="conversation-list">
          {% for conv in conversation_list %}
            <a href="{% url 'board:chat_detail' conv.id %}"
               class="list-group-item list-group-item-action d-flex align-items-center p-3
                      {% if active_conversation and active_conversation.id == conv.id %}active{% endif %}">
              <i class="bi bi-chat mr-3"></i>
              <div class="flex-grow-1">
                <div class="conversation-title">{{ conv.title|truncatechars:25 }}</div>
                <small class="text-muted">{{ conv.created_at|timesince }} 전</small>
              </div>
            </a>
          {% empty %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-chat-quote display-4 mb-3"></i>
              <p>아직 대화 기록이 없습니다.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 메인 채팅 영역 -->
    <div class="col-12 col-md-9 d-flex flex-column">
      <!-- 채팅 메시지 영역 -->
      <div id="chat-messages" class="flex-grow-1">        {% if active_conversation %}
          {% for message in messages %}
            {% if message.is_user %}
              <div class="chat-message user-message">
                <div class="message-bubble">
                  {{ message.message|linebreaks }}
                </div>
                <div class="message-avatar user-avatar">{{ user.username|first|upper }}</div>
              </div>
            {% else %}
              <div class="chat-message bot-message">
                <div class="message-avatar bot-avatar">
                  <i class="bi bi-robot"></i>
                </div>
                <div class="message-bubble">
                  {{ message.message|linebreaks }}
                </div>
              </div>            {% endif %}
          {% endfor %}
        {% else %}
          <div class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center">
              <h3 class="text-muted mb-3">전주대학교 인공지능학과 AI챗봇과 대화를 시작하세요!</h3>
              <p class="text-secondary">인공지능학과와 관련된 궁금한 것이 있다면 언제든지 물어보세요.</p>
              <button class="btn btn-primary btn-lg" onclick="document.querySelector('input[name=question]').focus()">
                <i class="bi bi-chat-dots mr-2"></i>대화 시작하기
              </button>
            </div>
          </div>
        {% endif %}
      </div>

      <!-- 입력 영역 -->
      <div class="chat-input-area">
        <div class="chat-input-container">
          {% if active_conversation %}
            <script>
              window.currentConversationId = "{{ active_conversation.id }}";
            </script>
          {% else %}
            <script>
              window.currentConversationId = null;
            </script>
          {% endif %}

          <!-- 질문 입력 폼 -->
          <form id="chat-form" class="mb-3">
            {% csrf_token %}
            <div class="input-group">
              <input type="text" name="question" class="form-control" 
                     placeholder="메시지를 입력하세요..." autofocus>
              <div class="input-group-append">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </div>
          </form>

          <!-- 파일 업로드 (관리자 전용) -->
          {% if user.is_staff %}
            <div class="file-upload-area">
              <form id="upload-form" action="{% url 'board:upload_file' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="d-flex align-items-center">
                  <i class="bi bi-cloud-upload text-primary mr-3"></i>
                  <div class="flex-grow-1">
                    <input type="file" name="file" id="file-input" class="form-control-file">
                    <small class="text-muted">PDF, TXT 파일을 업로드하여 AI가 학습할 수 있습니다.</small>
                  </div>
                  <button type="submit" class="btn btn-outline-primary ml-3">
                    <i class="bi bi-upload mr-1"></i>업로드
                  </button>
                </div>
                <div id="upload-result" class="mt-2"></div>
              </form>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
// 전역 변수
let isTyping = false;

// 사이드바 토글 기능
function initSidebar() {
  const sidebar = document.getElementById('sidebar');
  const sidebarToggleBtn = document.getElementById('sidebar-toggle');
  const sidebarCloseBtn = document.getElementById('sidebar-close');

  // 모바일에서 사이드바 토글
  sidebarToggleBtn?.addEventListener('click', function() {
    sidebar.classList.toggle('show');
  });

  // 사이드바 닫기
  sidebarCloseBtn?.addEventListener('click', function() {
    sidebar.classList.remove('show');
  });
}

// 메시지 생성 함수
function createUserMessage(message, username) {
  return `
    <div class="chat-message user-message">
      <div class="message-avatar user-avatar">${username.charAt(0).toUpperCase()}</div>
      <div class="message-bubble">${message}</div>
    </div>
  `;
}

function createBotMessage(isTemporary = false) {
  const tempId = isTemporary ? 'temp-bot-message' : '';
  const content = isTemporary ? 
    '<div class="typing-indicator"><span></span><span></span><span></span></div>' : 
    '<span class="bot-response"></span>';
    
  return `
    <div class="chat-message bot-message" ${tempId ? `id="${tempId}"` : ''}>
      <div class="message-avatar bot-avatar">
        <i class="bi bi-robot"></i>
      </div>
      <div class="message-bubble">
        ${content}
      </div>
    </div>
  `;
}

// 채팅 메시지 자동 스크롤
function scrollToBottom() {
  const chatMessages = document.getElementById('chat-messages');
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// 채팅 폼 처리
function initChatForm() {
  const chatForm = document.getElementById('chat-form');
  const questionInput = chatForm.querySelector('input[name="question"]');
  const submitBtn = chatForm.querySelector('button[type="submit"]');
  
  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const question = questionInput.value.trim();
    if (!question || isTyping) return;
    
    isTyping = true;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    
    const chatMessages = document.getElementById('chat-messages');
    const username = '{{ user.username }}';
    
    // 사용자 메시지 표시
    chatMessages.insertAdjacentHTML('beforeend', createUserMessage(question, username));
    
    // 타이핑 인디케이터 표시
    chatMessages.insertAdjacentHTML('beforeend', createBotMessage(true));
    scrollToBottom();
    
    // 서버로 요청 전송
    sendChatRequest(question, chatMessages, questionInput, submitBtn);
  });
  
  // Enter 키 처리
  questionInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      chatForm.dispatchEvent(new Event('submit'));
    }
  });
}

// 채팅 요청 전송
function sendChatRequest(question, chatMessages, questionInput, submitBtn) {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const formData = new FormData();
  
  formData.append('question', question);
  if (window.currentConversationId) {
    formData.append('conversation_id', window.currentConversationId);
  }

  fetch("{% url 'board:stream_answer' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
    body: formData
  })
  .then(response => {
    const convId = response.headers.get('X-Conversation-ID');
    if (convId && !window.currentConversationId) {
      window.currentConversationId = convId;
      // 페이지 URL 업데이트 (필요시)
      // window.history.pushState({}, '', `/chat/${convId}/`);
    }
    return response.body;
  })
  .then(body => {
    // 타이핑 인디케이터 제거
    const tempMessage = document.getElementById('temp-bot-message');
    if (tempMessage) tempMessage.remove();
    
    // 실제 봇 메시지 생성
    chatMessages.insertAdjacentHTML('beforeend', createBotMessage());
    const responseElement = chatMessages.querySelector('.bot-response:last-of-type');
    
    // 스트림 읽기
    const reader = body.getReader();
    const decoder = new TextDecoder();
    let accumulatedText = '';

    function readStream() {
      reader.read().then(({ done, value }) => {
        if (done) {
          isTyping = false;
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-send"></i>';
          questionInput.value = '';
          questionInput.focus();
          return;
        }
        
        const chunk = decoder.decode(value, { stream: true });
        accumulatedText += chunk;
        
        // 마크다운 또는 HTML 처리 (필요시)
        responseElement.innerHTML = accumulatedText.replace(/\n/g, '<br>');
        scrollToBottom();
        
        readStream();
      });
    }
    
    readStream();
  })
  .catch(error => {
    console.error('채팅 오류:', error);
    
    // 오류 메시지 표시
    const tempMessage = document.getElementById('temp-bot-message');
    if (tempMessage) tempMessage.remove();
    
    chatMessages.insertAdjacentHTML('beforeend', `
      <div class="chat-message bot-message">
        <div class="message-avatar bot-avatar">
          <i class="bi bi-exclamation-triangle text-warning"></i>
        </div>
        <div class="message-bubble bg-danger text-white">
          죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.
        </div>
      </div>
    `);
    
    isTyping = false;
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="bi bi-send"></i>';
    scrollToBottom();
  });
}

// 파일 업로드 처리
function initFileUpload() {
  const uploadForm = document.getElementById('upload-form');
  if (!uploadForm) return;
  
  const fileInput = document.getElementById('file-input');
  const uploadResult = document.getElementById('upload-result');
  
  uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(uploadForm);
    const csrfToken = uploadForm.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // 업로드 상태 표시
    uploadResult.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-cloud-upload-fill mr-2"></i>파일을 업로드하는 중...
      </div>
    `;
    
    fetch(uploadForm.action, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrfToken },
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        uploadResult.innerHTML = `
          <div class="alert alert-success">
            <i class="bi bi-check-circle-fill mr-2"></i>
            파일 업로드 성공: ${data.file_name}
          </div>
        `;
        fileInput.value = '';
      } else {
        uploadResult.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill mr-2"></i>
            업로드 실패: ${data.message}
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('파일 업로드 오류:', error);
      uploadResult.innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill mr-2"></i>
          파일 업로드 중 오류가 발생했습니다.
        </div>
      `;
    });
  });
}

// 초기화
document.addEventListener('DOMContentLoaded', function() {
  initSidebar();
  initChatForm();
  initFileUpload();
  
  // 페이지 로드 시 입력창에 포커스
  const questionInput = document.querySelector('input[name="question"]');
  if (questionInput) {
    questionInput.focus();
  }
  
  // 기존 메시지가 있으면 스크롤
  scrollToBottom();
});
</script>
{% endblock %}
