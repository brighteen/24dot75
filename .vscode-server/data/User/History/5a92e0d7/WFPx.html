{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- 사이드바 -->
    <div id="sidebar" class="col-md-3 p-0 d-none d-md-block">
      <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h5 class="mb-0">
            <i class="bi bi-chat-text mr-2"></i>대화 기록
          </h5>
          <button id="sidebar-close" class="btn btn-sm btn-light d-md-none">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        
        <a href="{% url 'board:chat' %}" class="btn btn-primary btn-block mb-3">
          <i class="bi bi-plus-circle mr-2"></i>새 채팅 시작
        </a>
        
        <div class="conversation-list">
          {% for conv in conversation_list %}
            <a href="{% url 'board:chat_detail' conv.id %}"
               class="list-group-item list-group-item-action d-flex align-items-center p-3
                      {% if active_conversation and active_conversation.id == conv.id %}active{% endif %}">
              <i class="bi bi-chat mr-3"></i>
              <div class="flex-grow-1">
                <div class="conversation-title">{{ conv.title|truncatechars:25 }}</div>
                <small class="text-muted">{{ conv.created_at|timesince }} 전</small>
              </div>
            </a>
          {% empty %}
            <div class="text-center text-muted py-4">
              <i class="bi bi-chat-quote display-4 mb-3"></i>
              <p>아직 대화 기록이 없습니다.</p>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 메인 채팅 영역 -->
    <div class="col-12 col-md-9 d-flex flex-column">
      <!-- 채팅 메시지 영역 -->
      <div id="chat-messages" class="flex-grow-1">
        {% if active_conversation %}
          {% for message in messages %}
            {% if message.is_user %}
              <div class="chat-message user-message">
                <div class="message-avatar user-avatar">{{ user.username|first|upper }}</div>
                <div class="message-bubble">
                  {{ message.message|linebreaks }}
                </div>
              </div>
            {% else %}
              <div class="chat-message bot-message">
                <div class="message-avatar bot-avatar">
                  <i class="bi bi-robot"></i>
                </div>
                <div class="message-bubble">
                  {{ message.message|linebreaks }}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="d-flex align-items-center justify-content-center h-100">
            <div class="text-center">
              <i class="bi bi-chat-heart display-1 text-primary mb-4"></i>
              <h3 class="text-muted mb-3">AI 챗봇과 대화를 시작하세요!</h3>
              <p class="text-secondary">궁금한 것이 있다면 언제든지 물어보세요.</p>
              <button class="btn btn-primary btn-lg" onclick="document.querySelector('input[name=question]').focus()">
                <i class="bi bi-chat-dots mr-2"></i>대화 시작하기
              </button>
            </div>
          </div>
        {% endif %}
      </div>

      <!-- 입력 영역 -->
      <div class="chat-input-area">
        <div class="chat-input-container">
          {% if active_conversation %}
            <script>
              window.currentConversationId = "{{ active_conversation.id }}";
            </script>
          {% else %}
            <script>
              window.currentConversationId = null;
            </script>
          {% endif %}

          <!-- 질문 입력 폼 -->
          <form id="chat-form" class="mb-3">
            {% csrf_token %}
            <div class="input-group">
              <input type="text" name="question" class="form-control" 
                     placeholder="메시지를 입력하세요..." autofocus>
              <div class="input-group-append">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i>
                </button>
              </div>
            </div>
          </form>

          <!-- 파일 업로드 (관리자 전용) -->
          {% if user.is_staff %}
            <div class="file-upload-area">
              <form id="upload-form" action="{% url 'board:upload_file' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="d-flex align-items-center">
                  <i class="bi bi-cloud-upload text-primary mr-3"></i>
                  <div class="flex-grow-1">
                    <input type="file" name="file" id="file-input" class="form-control-file">
                    <small class="text-muted">PDF, TXT 파일을 업로드하여 AI가 학습할 수 있습니다.</small>
                  </div>
                  <button type="submit" class="btn btn-outline-primary ml-3">
                    <i class="bi bi-upload mr-1"></i>업로드
                  </button>
                </div>
                <div id="upload-result" class="mt-2"></div>
              </form>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
// (A) 사이드바 열기/닫기
const sidebar = document.getElementById('sidebar');
const sidebarCloseBtn = document.getElementById('sidebar-close');
const sidebarToggleBtn = document.getElementById('sidebar-toggle');

// 닫기 버튼 -> 사이드바 숨김
sidebarCloseBtn.addEventListener('click', function() {
  sidebar.classList.add('d-none');
});

// 열기 버튼 -> 사이드바 표시
sidebarToggleBtn?.addEventListener('click', function() {
  sidebar.classList.remove('d-none');
});

// (B) 채팅 폼 전송
document.getElementById('chat-form').addEventListener('submit', function(e){
  e.preventDefault();
  const form = e.target;
  const questionInput = form.querySelector('input[name="question"]');
  const question = questionInput.value.trim();
  if (!question) return;

  const chatMessages = document.getElementById('chat-messages');

  // 사용자 메시지 표시
  const userMessageElem = document.createElement('div');
  userMessageElem.className = 'chat-message user-message mb-2 text-right';
  userMessageElem.innerHTML = `<p><strong>나:</strong> ${question}</p>`;
  chatMessages.appendChild(userMessageElem);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  // 서버 전송
  const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
  const formData = new FormData();
  formData.append('question', question);
  if (window.currentConversationId) {
    formData.append('conversation_id', window.currentConversationId);
  }

  fetch("{% url 'board:stream_answer' %}", {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
    body: formData
  })
  .then(response => {
    const convId = response.headers.get('X-Conversation-ID');
    if (convId && !window.currentConversationId) {
      window.currentConversationId = convId;
    }
    return response.body;
  })
  .then(body => {
    const reader = body.getReader();
    const decoder = new TextDecoder();
    let accumulatedText = '';

    // 봇 답변 메시지
    const botMessageElem = document.createElement('div');
    botMessageElem.className = 'chat-message bot-message mb-2 text-left bg-light p-2 rounded';
    botMessageElem.innerHTML = `<p><strong>챗봇:</strong> <span id="answer-text"></span></p>`;
    chatMessages.appendChild(botMessageElem);
    const answerTextElem = botMessageElem.querySelector('#answer-text');

    const readStream = () => {
      reader.read().then(({ done, value }) => {
        if (done) return;
        const chunk = decoder.decode(value, { stream: true });
        accumulatedText += chunk;
        answerTextElem.innerHTML = accumulatedText;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        readStream();
      });
    };
    readStream();
  })
  .catch(error => {
    console.error('Error during streaming:', error);
  });

  questionInput.value = '';
});

// (C) 파일 업로드
document.getElementById('upload-form')?.addEventListener('submit', function(e) {
  e.preventDefault();
  const form = e.target;
  const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
  const formData = new FormData(form);

  fetch(form.action, {
    method: 'POST',
    headers: { 'X-CSRFToken': csrfToken },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    const resultElem = document.getElementById('upload-result');
    if (data.status === 'success') {
      resultElem.innerHTML = `<p class="text-success">파일 업로드 성공: ${data.file_name}</p>`;
    } else {
      resultElem.innerHTML = `<p class="text-danger">파일 업로드 실패: ${data.message}</p>`;
    }
  })
  .catch(error => {
    console.error('파일 업로드 오류:', error);
    document.getElementById('upload-result').innerHTML = `<p class="text-danger">파일 업로드 중 오류 발생</p>`;
  });
});
</script>
{% endblock %}
